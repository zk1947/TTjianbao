#é¡¹ç›®ä¸­targetçš„åç§°
schemeName = ""
# ç‰ˆæœ¬å·
version = ""

export_method = "development"
#ipa å
output_name = ""

#è’²å…¬è‹±AppKey
pgyerAppKey = "7175a5a5068d3c408f4b19be21a25e33"

#è’²å…¬è‹±Api_key
pgyerApi_key = "c077f03507f2d0122e203e8a3662fcee"
#è’²å…¬è‹±User_key
pgyerUser_key = "e195a321a191e2b0736b14f2bf1ffdd5"
#é’‰é’‰token
dingToken = "32440629c388115a95b9c647046a39d50d8091a93b05e4ae25fa2944e11fd375"
# dingToken = "17b002acf1c7813828265d2696a2528e2a16fe58c8b4d287c3ca33af1b92c870"
#bugly
devBuglyAppId = "f41366009e"
devBuglyAppKey = "49275194-b347-46dd-811b-5a3c0247cc7a"
buglyAppId = "7fe8814afe"
buglyAppKey = "3aa17acc-0784-47d9-b503-7ff811c52fe5"
#
bundle_id = "com.tianmou.jianbao"


default_platform(:ios)
platform :ios do     #æŒ‡å®šæŒç»­é›†æˆå¯¹è±¡çš„å¹³å°åç§°
    before_all do |lane, options|
        schemeName = options[:schemeName]
        
        version = get_version_number_from_xcodeproj(
             xcodeproj: "TTjianbao.xcodeproj", 
             target: schemeName, 
        )
        if schemeName == "TTjianbaoGuoji" 
            bundle_id = "com.tianmou.jianbaoguoji"
            pgyerAppKey = "7d78fe9514c963638d5d673f02ceb43a"
        end
        puts "------#{schemeName}-------"
    end
    # ----------------------- æ‰“åŒ…å†…æµ‹.ipaæ–‡ä»¶ -----------------------
    lane :debug do 
        puts "*************| å¼€å§‹æ‰“åŒ…-Debug |*************"
        export_method = "development"
        #é’‰é’‰æ¶ˆæ¯-å¼€å§‹æ‰“åŒ…
        dingMsg(methodText: "-æµ‹è¯•-")
        
        package(configuration: "Debug")
        #è’²å…¬è‹±ä¸Šä¼ 
        pgyerUpdate()
        #é’‰é’‰é€šçŸ¥
        dingTalk(methodText: "-æµ‹è¯•-")
    end

    lane :release do 
        puts "*************| å¼€å§‹æ‰“åŒ…-Release |*************"
        #é’‰é’‰æ¶ˆæ¯-å¼€å§‹æ‰“åŒ…
        dingMsg(methodText: "-å‘å¸ƒ-")
        export_method = "ad-hoc"
        # match(
        #     type:appstore,
            # readonly:true,
        # )
        package(configuration: "Release")
        #è’²å…¬è‹±ä¸Šä¼ 
        pgyerUpdate()
        #é’‰é’‰é€šçŸ¥
        dingTalk(methodText: "-å‘å¸ƒ-", version: version)
    end

    lane :appStore do
        puts "*************| å¼€å§‹æ‰“åŒ…-AppStore |*************"
        export_method = "app-store"
        # package(configuration: "Release")
        deliver(
            # é€‰æ‹©è·³è¿‡å›¾ç‰‡å’Œå…ƒæ•°æ®ä¸Šä¼ ï¼Œè‡ªå·±å»é…ç½®
            skip_screenshots:true,
            skip_metadata:true,
            # ä¸Šä¼ æ‰€æœ‰ä¿¡æ¯åˆ°App Store
            force:true,
            )
        puts "*************| ä¸Šä¼ AppStoreæˆåŠŸğŸ‰ |*************"
        
    end

    lane :testFlight do
        puts "*************| å¼€å§‹æ‰“åŒ…-TestFlight |*************"
        export_method = "app-store"

        dingMsg(methodText: "-TestFlight-")
        
        buildbump(buildNumber: latest_testflight_build_number(version: version))

        package(configuration: "Release")

        upload_to_testflight()

        ding_talk_msg_push(
            token: dingToken, 
            text: "å¤©å¤©é‰´å®-iOSæ„å»ºå®Œæˆ-TestFlight-åŒ…-ç‰ˆæœ¬å·:#{version} é“¾æ¥ï¼š https://testflight.apple.com/join/z509BScy", 
            at_all: false
        )
    end
    lane :uploadToTestflight do
        
        upload_to_testflight(
            ipa: "./fastlane/build/TTjianbao-app-store-2021-08-12-10-44.ipa",
        )
    end
    # ----------------------- æ‰“åŒ… -----------------------
    lane :package do |options| 
        
        #æ‰“åŒ…æ–¹å¼
        configuration = options[:configuration]
        if options[:configuration] == nil 
            configuration = "Debug"
        end
        puts "*************| å¼€å§‹æ‰“åŒ… |-#{schemeName}-#{configuration}-*************"
        output_name = "#{schemeName}-#{export_method}-#{Time.new.strftime("%Y-%m-%d-%H-%M")}"
      
        gym(
            #æŒ‡å®šschemeçš„åå­—
            scheme: "#{schemeName}",
            #è¾“å‡ºçš„ipaåç§°
            output_name: output_name,
            # æ˜¯å¦æ¸…ç©ºä»¥å‰çš„ç¼–è¯‘ä¿¡æ¯ trueï¼šæ˜¯
            clean:true,
            # æŒ‡å®šæ‰“åŒ…æ–¹å¼ï¼ŒRelease æˆ–è€… Debug
            configuration: "#{configuration}",
            # éšè—æ²¡æœ‰å¿…è¦çš„ä¿¡æ¯
            silent:true,
            # æŒ‡å®šæ‰“åŒ…æ‰€ä½¿ç”¨çš„è¾“å‡ºæ–¹å¼ï¼Œç›®å‰æ”¯æŒapp-store, package, ad-hoc, enterprise, development
            export_method:  "#{export_method}",
            # æŒ‡å®šè¾“å‡ºæ–‡ä»¶å¤¹ï¼Œè¿™é‡Œä¼šä¿å­˜æˆ‘ä»¬æœ€åç”Ÿæˆçš„ipaæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯å­˜åˆ°äº†æˆ‘ä»¬ä¸Šé¢æåˆ°çš„fastlaneæ–‡ä»¶å¤¹ä¸­çš„buildæ–‡ä»¶å¤¹ä¸­
            output_directory:"./fastlane/build",
            # è‡ªåŠ¨ç­¾å
            xcargs: "-allowProvisioningUpdates",
        )

        # ä¸Šä¼ dsym åˆ°bugly
        updateDsym(version: version, configuration:configuration)
    end

    # ----------------------- é’‰é’‰é€šçŸ¥ -----------------------
    lane :dingTalk do |options|
        #é’‰é’‰é€šçŸ¥
        puts "é’‰é’‰é€šçŸ¥"
        methodText = options[:methodText]
        desc = "å¤©å¤©é‰´å®-iOSæ„å»ºå®Œæˆ-#{methodText}åŒ…-ç‰ˆæœ¬å·:#{version}-ä¸‹è½½åœ°å€ï¼šhttps://www.pgyer.com/1Ncu"
        puts desc
        # é’‰é’‰æœºå™¨äººé€šçŸ¥
        ding_talk(
            access_token: dingToken,
            api_key: "#{pgyerApi_key}",
            app_key: "#{pgyerAppKey}",
            markdown_desc: desc,
        )
    end

    lane :dingMsg do |options|
        methodText = options[:methodText]
        ding_talk_msg_push(token: dingToken, text: "å¤©å¤©é‰´å®-iOSå¼€å§‹æ„å»º-#{methodText}åŒ…-ç‰ˆæœ¬å·:#{version}", at_all: false)
    end

    # ----------------------- è’²å…¬è‹± -----------------------
    lane :pgyerUpdate do |options|
        puts "***************å¼€å§‹ä¸Šä¼ åˆ°è’²å…¬è‹±****************"
        #å¼€å§‹ä¸Šä¼ ipaåˆ°è’²å…¬è‹±ï¼Œè¿™é‡Œç”¨çš„æ˜¯è’²å…¬è‹±æä¾›çš„æ’ä»¶
        #update_descriptionä»£è¡¨æ›´æ–°ä¿¡æ¯ï¼Œpasswordä»£è¡¨å®‰è£…å¯†ç 
        pgyer(
            update_description: "#{"å¤©å¤©é‰´å®"}", 
            api_key: "#{pgyerApi_key}", 
            user_key: "#{pgyerUser_key}", 
            password: "1234", 
            install_type: "2",
        )
    end

    # ----------------------- ä¸Šä¼ dsym -----------------------
    lane :updateDsym do |options| 
        #ä¸Šä¼ dsym
        puts "å¼€å§‹ä¸Šä¼ dsym"
        appid = buglyAppId
        appKey = buglyAppKey
    
        if options[:configuration] == "Debug" 
            appid = devBuglyAppId
            appKey = devBuglyAppKey
        end

        upload_dsym_to_bugly(
            file_path: "./fastlane/build/#{output_name}.app.dSYM.zip",
            app_key: appKey,
            app_id: appid,
            version: options[:version],
            bundle_id:bundle_id,
        )
    end
    # build å·è‡ªå¢
    lane :buildbump do |options|
        #ç‰ˆæœ¬å·
        
        build_number = options[:buildNumber]

        if build_number == nil
            build_number = "1"
        end
        
        if build_number == 1 
            build_number = version + ".0"
        elsif build_number[0..4] != version
            build_number = version + ".0"
        end

        lastStr = build_number[6..build_number.length]

        lastNum = lastStr.to_i
        lastNum = lastNum + 1
        lastStr = lastNum.to_s
        
        build = "#{version}.#{lastStr}"
      
        increment_build_number(
            build_number: build,
            xcodeproj: "TTjianbao.xcodeproj"
        )
    end
end

